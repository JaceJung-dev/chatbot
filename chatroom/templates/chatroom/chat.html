<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Chat</title>
    <style>
        .loading {
            font-style: italic;
            color: gray;
        }
    </style>
</head>
<body>
    <h2>WebSocket 챗봇</h2>
    <div id="chat-box"></div>
    <input type="text" id="message-input" placeholder="메시지를 입력하세요">
    <button onclick="sendMessage()">보내기</button>

    <script>
        const chatroom_id = 1; // 원하는 채팅방 ID
        const socket = new WebSocket(`ws://127.0.0.1:8000/ws/chatroom/${chatroom_id}/`);

        socket.onopen = function () {
            console.log("✅ WebSocket 연결 성공!");
        };

        socket.onmessage = function (event) {
            const data = JSON.parse(event.data);
            console.log("📨 사용자 메시지:", data.user_message);
            console.log("🤖 챗봇 응답:", data.bot_message);

            const chatBox = document.getElementById("chat-box");

            if (data.bot_message === "⌛ 답변을 생성 중입니다...") {
                // 상태 메시지를 표시 (로딩 효과 추가)
                chatBox.innerHTML += `<p class="loading" id="loading-message"><b>챗봇:</b> ${data.bot_message}</p>`;
            } else {
                // 기존 "답변을 생성 중입니다..." 문구를 대체
                let loadingMessage = document.getElementById("loading-message");
                if (loadingMessage) {
                    loadingMessage.remove(); // 기존 로딩 메시지 삭제
                }
                // 실제 챗봇 응답 추가
                chatBox.innerHTML += `<p><b>챗봇:</b> ${data.bot_message}</p>`;
            }
        };

        function sendMessage() {
            const inputField = document.getElementById("message-input");
            const message = inputField.value;

            // 사용자 메시지 표시
            const chatBox = document.getElementById("chat-box");
            chatBox.innerHTML += `<p><b>사용자:</b> ${message}</p>`;

            // WebSocket으로 메시지 전송
            socket.send(JSON.stringify({ message: message }));
            inputField.value = "";
        }
    </script>
</body>
</html>
